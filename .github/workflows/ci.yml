name: CI

on:
  pull_request:
    branches:
      - main

jobs:
  # ── Unit tests ─────────────────────────────────────────────────────────────
  # Run the full test suite across all supported Python versions on both
  # Ubuntu LTS releases to catch any OS-level regressions.
  test:
    name: Test (Python ${{ matrix.python-version }} / ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
        python-version: ['3.9', '3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests
        run: pytest tests/ -v

  # ── Build checks ───────────────────────────────────────────────────────────
  # Verify that flet pack produces a working binary on every supported OS
  # version.  macOS covers both Intel (13) and Apple Silicon (14, 15).
  # Windows covers Server 2019 (Win 10 era) and Server 2022 (Win 11 era).
  build-check:
    name: Build (${{ matrix.platform_name }})
    needs: test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # ── macOS ──────────────────────────────────────────────────────────
          - os: macos-13
            platform_name: "macOS 13 Ventura (Intel)"
          - os: macos-14
            platform_name: "macOS 14 Sonoma (Apple Silicon)"
          - os: macos-15
            platform_name: "macOS 15 Sequoia (Apple Silicon)"
          # ── Windows ────────────────────────────────────────────────────────
          - os: windows-2019
            platform_name: "Windows Server 2019"
          - os: windows-2022
            platform_name: "Windows Server 2022"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .
          pip install flet pyinstaller

      - name: Build (macOS)
        if: runner.os == 'macOS'
        run: >
          flet pack src/book_editor/__main__.py
          --name "Beckit"
          --product-name "Beckit"
          --file-description "A desktop app for writing books with GitHub version control"

      - name: Patch Info.plist bundle name (macOS)
        if: runner.os == 'macOS'
        run: |
          PLIST="dist/Beckit.app/Contents/Info.plist"
          /usr/libexec/PlistBuddy -c "Set :CFBundleName Beckit" "$PLIST"
          /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName Beckit" "$PLIST"
          echo "CFBundleName: $(/usr/libexec/PlistBuddy -c 'Print :CFBundleName' "$PLIST")"

      - name: Confirm binary (macOS)
        if: runner.os == 'macOS'
        run: test -f dist/Beckit.app/Contents/MacOS/Beckit

      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: >
          flet pack src/book_editor/__main__.py
          --name "Beckit"
          --product-name "Beckit"
          --file-description "A desktop app for writing books with GitHub version control"
          -D

      - name: Confirm binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (-not (Test-Path dist\Beckit\Beckit.exe)) {
            Write-Error "Expected dist\Beckit\Beckit.exe was not found"
            exit 1
          }
